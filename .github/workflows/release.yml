name: CI/CD Pipeline

run-name: 'Release Pipeline ${{ github.ref_name }}@${{ github.sha }}'

on:
  push:
    branches: [ main ]
  workflow_dispatch:


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: ./.github/actions/setup-node

    - name: Validate release configuration
      run: npm run verify-release-config

  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: ./.github/actions/setup-node

    - name: Lint commit messages
      run: npx commitlint --from $(git rev-list --max-parents=0 HEAD) --to HEAD || echo "Commit linting warnings found but continuing build"

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: ./.github/actions/setup-node

    - name: Run tests
      run: npm test
      env:
        NODE_ENV: test
        MOCK_API: true

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: ./.github/actions/setup-node

    - name: Build
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/
        retention-days: 1

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [ build, test, validate-config, lint ]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write # For semantic-release to create tags and releases
      pull-requests: write # For creating PRs and commenting on them
      issues: write # For creating issues and commenting on them
    outputs:
      new_release_published: ${{ steps.semantic-release.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic-release.outputs.new_release_version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true

    - name: Setup Node.js
      uses: ./.github/actions/setup-node

    - name: Release
      id: semantic-release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: npx semantic-release --debug

  # Note: Docker publishing is now handled by a separate workflow that triggers on tag creation
  # Note: Home Assistant addon building is now handled automatically
  # by the Builder workflow in the hassio-addons repository.
  # The Builder workflow detects submodule updates and builds addons automatically.
